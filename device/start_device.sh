#!/bin/bash

PYTHON_CMD=../env/bin/python3

GARAGE_APP_DIR=/app/garage
GARAGE_APP_SETTINGS_DIR="$GARAGE_APP_DIR/settings"
export DEVICE_ID_FILE="$GARAGE_APP_SETTINGS_DIR/device_id"
export SETTINGS_FILE="$GARAGE_APP_SETTINGS_DIR/settings.json"
export GOOGLE_APPLICATION_CREDENTIALS="$GARAGE_APP_SETTINGS_DIR/service_account.json"
export BOOTSTRAP_PORT=8080

echo Starting Sizaha device.

if [[ ! -d "$GARAGE_APP_SETTINGS_DIR" ]]; then
  mkdir -p "$GARAGE_APP_SETTINGS_DIR"
fi

if [[ ! -f "$DEVICE_ID_FILE" ]]; then
  DEVICE_ID=$RANDOM
  echo "$DEVICE_ID" > "$DEVICE_ID_FILE"
  # Change host name on the first run.
  nmcli general hostname "sizahagarage$DEVICE_ID"
else
  DEVICE_ID=`cat "$DEVICE_ID_FILE"`
fi

# Turn WiFi radio on... just in case.
nmcli radio wifi on

if [[ -f "$SETTINGS_FILE.tmp" ]]; then
  echo Testing device WiFi configuration
  $PYTHON_CMD setup_wifi.py
fi

# Check if settings file was generated by bootstrap server.
if [[ -f "$SETTINGS_FILE" ]]; then
  echo Launching Runtime service.
  $PYTHON_CMD ./garage_daemon.py
else
  export AP_NAME="Sizaha$DEVICE_ID"
  echo Launching bootstrap WiFi access point with SSID - $AP_NAME
  $PYTHON_CMD bootstrap_wifi.py --ssid "$AP_NAME" start

  echo Launching Bootstrap Server
  $PYTHON_CMD bootstrap_server.py

  echo Stopping bootstrap Access point
  $PYTHON_CMD bootstrap_wifi.py --ssid "$AP_NAME" stop
fi

reboot

